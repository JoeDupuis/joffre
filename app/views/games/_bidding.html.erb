<%
  bidding_order = @game.bidding_order
  positions = player_positions(bidding_order)
  current_player = positions[:current]
  partner = positions[:partner]
  opponent_left = positions[:opponent_left]
  opponent_right = positions[:opponent_right]

  active_bidder = @game.current_bidder
  highest_bid = @game.highest_bid
%>

<div class="game-info">
  <div class="info-item">
    <span class="info-label">Current Bid:</span>
    <span class="info-value"><%= highest_bid&.amount || @game.minimum_bid %></span>
  </div>
  <div class="info-item">
    <span class="info-label">High Bidder:</span>
    <span class="info-value">
      <% if highest_bid %>
        <%= highest_bid.player == current_player ? "You" : (highest_bid.player == partner ? partner.user.name : highest_bid.player.user.name) %>
      <% else %>
        None
      <% end %>
    </span>
  </div>
</div>

<div class="phase-area">
  <div class="phase-message">
    <% if Current.player&.is_current_bidder? %>
      Bidding - Your turn
    <% else %>
      <% if active_bidder %>
        Bidding - Waiting for <%= active_bidder == partner ? partner.user.name : active_bidder.user.name %>
      <% else %>
        Bidding
      <% end %>
    <% end %>
  </div>
</div>

<div class="bid-history">
  <div class="bid-history-title">Bidding Order</div>
  <div class="bid-list">
    <% bidding_order.each do |player| %>
      <% player_bid = @game.bids.find_by(player: player) %>
      <% is_current = player == active_bidder %>
      <div class="bid-item <%= 'current-turn' if is_current %>">
        <span class="bid-player">
          <%= player == current_player ? "You" : (player == partner ? partner.user.name : player.user.name) %>
        </span>
        <span class="bid-value <%= 'passed' if player_bid&.amount.nil? %>">
          <% if player_bid %>
            <%= player_bid.amount || "Pass" %>
          <% else %>
            <%= is_current ? "?" : "-" %>
          <% end %>
        </span>
      </div>
    <% end %>
  </div>
</div>

<% if Current.player&.is_current_bidder? %>
  <div class="bidding-controls">
    <div class="bid-input-section">
      <% minimum = highest_bid ? highest_bid.amount + 1 : @game.minimum_bid %>
      <% minimum.upto(12) do |amount| %>
        <%= button_to amount.to_s, game_bids_path(@game), method: :post, params: { bid: { amount: amount } }, class: "bid-option" %>
      <% end %>
    </div>
    <div class="button-group">
      <% unless @game.dealer_must_bid? && Current.player == @game.dealer && highest_bid.nil? %>
        <%= button_to "Pass", game_bids_path(@game), method: :post, params: { bid: { amount: '' } }, class: "bid-button secondary" %>
      <% end %>
    </div>
  </div>
<% end %>
