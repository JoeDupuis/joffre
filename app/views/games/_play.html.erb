<%
  positions = player_positions(@game.play_order)
  current_player = positions[:current]
  partner = positions[:partner]
  opponent_left = positions[:opponent_left]
  opponent_right = positions[:opponent_right]

  active_player = @game.active_player
  current_trick = @game.current_trick
  highest_bid = @game.highest_bid
  trump_suit = @game.trump_suit

  total_tricks = @game.tricks.where(completed: true).count
  team_tricks = 0
  if current_player
    team_tricks = current_player.tricks_won.count
    if partner
      team_tricks += partner.tricks_won.count
    end
  end

  played_cards = current_trick.cards.order(:trick_sequence).to_a
  cards_by_player = {}
  played_cards.each do |card|
    cards_by_player[card.player.id] = card
  end
%>

<div class="game-info">
  <div class="info-item">
    <span class="info-label">Trump:</span>
    <span class="info-value"><%= trump_suit&.capitalize || "None" %></span>
  </div>
  <div class="info-item">
    <span class="info-label">Bid:</span>
    <span class="info-value"><%= highest_bid&.amount || "N/A" %></span>
  </div>
  <div class="info-item">
    <span class="info-label">Bidder:</span>
    <span class="info-value">
      <% if highest_bid %>
        <%= highest_bid.player == current_player ? "You" : (highest_bid.player == partner ? partner.user.name : highest_bid.player.user.name) %>
      <% else %>
        N/A
      <% end %>
    </span>
  </div>
  <div class="info-item">
    <span class="info-label">Tricks:</span>
    <span class="info-value"><%= team_tricks %>/8</span>
  </div>
</div>

<div class="phase-area">
  <div class="phase-message">
    <% if Current.player&.active? %>
      Playing - Your turn
    <% else %>
      <% if active_player %>
        Playing - Waiting for <%= active_player == partner ? partner.user.name : active_player.user.name %>
      <% else %>
        Playing
      <% end %>
    <% end %>
  </div>
</div>

<div class="game-container">
  <% if opponent_left %>
    <div class="opponent-left <%= 'active-turn' if active_player == opponent_left %>">
      <span><%= opponent_left.user.name %></span>
      <% if opponent_left.dealer? %>
        <span class="dealer-pill">Dealer</span>
      <% end %>
    </div>
  <% end %>

  <div class="play-area-wrapper">
    <% if partner %>
      <div class="partner-name <%= 'active-turn' if active_player == partner %>">
        <span><%= partner == current_player ? "You" : partner.user.name %></span>
        <% if partner.dealer? %>
          <span class="dealer-pill">Dealer</span>
        <% end %>
      </div>
    <% end %>

    <div class="play-area">
      <% if partner && cards_by_player[partner.id] %>
        <% card = cards_by_player[partner.id] %>
        <div class="played-card top">
          <%= image_tag "cards/#{card.suite}_#{card.rank}.png", alt: "#{card.suite.capitalize} #{card.rank}" %>
        </div>
      <% end %>

      <% if opponent_left && cards_by_player[opponent_left.id] %>
        <% card = cards_by_player[opponent_left.id] %>
        <div class="played-card left">
          <%= image_tag "cards/#{card.suite}_#{card.rank}.png", alt: "#{card.suite.capitalize} #{card.rank}" %>
        </div>
      <% end %>

      <% if opponent_right && cards_by_player[opponent_right.id] %>
        <% card = cards_by_player[opponent_right.id] %>
        <div class="played-card right">
          <%= image_tag "cards/#{card.suite}_#{card.rank}.png", alt: "#{card.suite.capitalize} #{card.rank}" %>
        </div>
      <% end %>

      <% if current_player && cards_by_player[current_player.id] %>
        <% card = cards_by_player[current_player.id] %>
        <div class="played-card bottom">
          <%= image_tag "cards/#{card.suite}_#{card.rank}.png", alt: "#{card.suite.capitalize} #{card.rank}" %>
        </div>
      <% end %>
    </div>

    <% if current_player %>
      <div class="player-name <%= 'active-turn' if active_player == current_player %>">
        <span>You</span>
        <% if current_player.dealer? %>
          <span class="dealer-pill">Dealer</span>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if opponent_right %>
    <div class="opponent-right <%= 'active-turn' if active_player == opponent_right %>">
      <span><%= opponent_right.user.name %></span>
      <% if opponent_right.dealer? %>
        <span class="dealer-pill">Dealer</span>
      <% end %>
    </div>
  <% end %>
</div>
